<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SCSOSS, DU</title>
  <link rel="shortcut icon" href="/media/favicon.ico" type="image/x-icon"/>
  <link rel="icon" type="image/png" sizes="66x41" href="/media/logo1.png">
  <link rel="apple-touch-icon" type="image/png" sizes="66x41" href="/media/logo1.png">
  <meta content='#8a10af' name='theme-color'/>
  <meta name="copyright" content="scsoss_du">
  <meta name="author" content="scsoss_du">
  <meta content='Bangladesh' name='geo.placename'/>
  <meta content='880' name='geo.country'/>
  <link rel="manifest" href="manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="application-name" content="scsoss_du">
  <meta name="apple-mobile-web-app-title" content="scsoss_du">
  <meta name="msapplication-navbutton-color" content="#8a10af">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="msapplication-starturl" content="/">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
  <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
  <!-- Bulma Version 0.6.0 -->
  <link rel="stylesheet" href="/css/bulma.css" type="text/css"/>
  <link rel="stylesheet" href="/css/index.css" type="text/css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/v/dt/dt-1.10.18/b-1.5.4/b-flash-1.5.4/b-html5-1.5.4/b-print-1.5.4/r-2.2.2/datatables.min.css">
</head>
<body class="has-navbar-fixed-top">
    <nav class="navbar is-fixed-top">
      <div class="container">
        <div class="navbar-brand">
          <a class="navbar-item" href="../">
            <img class="nav-logo" src="/media/logo.png" alt="Logo">
          </a>
          <span class="navbar-burger burger" data-target="navbarMenu">
            <span></span>
            <span></span>
            <span></span>
          </span>
        </div>
        <div id="navbarMenu" class="navbar-menu">
          <div class="navbar-end">
            <a class="navbar-item is-active" href="/">
              Home
            </a>
            
            <% if (!user){ %>
            <a class="navbar-item" href="/Prabhupada">
              Prabhupada
            </a>
            <a class="navbar-item" href="/info">
              Information
            </a>
            <a class="navbar-item" href="/login">
              login
            </a>
            <% }else { %>
              <div class="navbar-item">
                <div class="field is-grouped">
                    <p class="control">
                        <a class="button is-white" href="#">
                            <span class="icon"><i class="fa fa-bug"></i></span>
                            <span class="open-modal" data-modal-id="#bug-report"> Report bug </span>
                        </a>
                    </p>
                    <p class="control">
                        <a class="button is-white" href="#">
                            <span class="icon badge is-badge-danger" data-badge="3" id="notification"><i class="fa fa-bell"></i></span>
                        </a>
                    </p>
                </div>
            </div>
              <div class="navbar-item has-dropdown is-hoverable">
                <a class="navbar-link is-grouped" href="/admin">
                    <!-- <figure class="image is-24x24 is-rounded">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/8/89/Portrait_Placeholder.png">
                    </figure> -->
                    <span> <%= user.username %></span>
                 </a>
                <div class="navbar-dropdown">
                    <a class="navbar-item is-leveled " href="# ">
                        Messages
                        <span class="icon "><i class="fa fa-comments "></i></span>
                    </a>
                    <a class="navbar-item is-leveled " href="/logout">
                        Sign Out
                        <span class="icon "><i class="fa fa-sign-out "></i></span>
                    </a>
                </div>
            </div>
            <% } %>
          </div>
        </div>
      </div>
    </nav>
  <!-- </div> -->
  <% if (user){ %>
<div class="sidenav" id='mySidenav'>
      <aside class="menu">
          <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
          <p class="menu-label"> Menu </p>
            <ul class="menu-list">
              <li>
                <a href="/admin">
                  <span class="icon "><i class="fa fa-tachometer"></i></span>
                  Dashboard
                </a>
              </li>
              <li>
                <a href="/meal">
                  <span class="icon"><i class="fa fa-book"></i></span>
                  মিল
                </a>
              </li>
              <li>
                <a href="/devotee">
                  <span class="icon"><i class="fa fa-address-book"></i></span>
                  ভক্তদের তালিকা
                </a>
              </li>
              <li>
                <a href="/cost">
                  <span class="icon "><i class="fa fa-file-text-o"></i> </span>
                  খরচ
                </a>
              </li>
            </ul>
          <p class="menu-label is-active"> Administration </p>
            <ul class="menu-list ">
              <li>
                <a href="/user">
                  <span class="icon "><i class="fa fa-user-circle-o"></i></span>
                  Users
                </a>       
              </li>      
              <li>  
                <a href="/settings">
                  <span class="icon"><i class="fa fa-cog"></i></span>
                  Settings  
                </a>              
              </li>
              <li>
                <a href="/analysis">
                  <span class="icon "><i class="fa fa-pie-chart"></i></span>
                  Analysis
                </a>
              </li>
              <li>
                  <a href="/bug">
                    <span class="icon "><i class="fa fa-bug"></i></span>
                    Bugs
                  </a>
              </li>
              <li>
                <a href="/report?num=1">
                  <span class="icon "><i class="fa fa-bug"></i></span>
                  Report
                </a>
            </li>     
            </ul>    
      </aside>
    </div>
  <% } %>

<div class="container load">
   <!--Connect Flash-->
  <div class="container">
    <% if (error && error.length>0){%>
      <div class="notification is-danger">
        <%= error %>
      </div>
    <% } %>
    <% if(success && success.length>0){ %>
      <div class="notification is-success">
        <%= success %>
      </div>
    <% } %>  
  </div> 
  <div class="column is-12" id="main">
    <section class="hero is-info welcome is-small">
      <div class="hero-body">
        <div class="container">
          <h1 class="title"><span style="cursor:pointer" onclick="openNav()">&#9776;</span> Hello, Admin. </h1>
        </div>
      </div>
    </section>
    <% let result = devotee.map(({name, meals, deposits}) => ({name, meals : meals.reduce((a,c) => a + c.num, 0), deposits : deposits.reduce((a,c) => a + c.amount, 0)})); %>
    <% var totalD= [], totalM = []; for(let f in result){totalD.push(result[f].deposits); totalM.push(result[f].meals);} %>
    <% var tCosts= []; for(let i in cost){tCosts.push(cost[i].amount);} function sum(num){return num.reduce((a,b)=>{return a+b;}, 0);} %>
    
    <section class="info-tiles">
      <div class="tile is-ancestor has-text-centered">
        
        <div class="tile is-parent">
          <article class="tile is-child box">
<% var mealRate = Math.round(sum(tCosts)/sum(totalM)).toFixed(2); var totalCost =sum(tCosts); var totalIncome =sum(totalD);  %>
            <p class="title"><%= mealRate  %></p>
            <p class="subtitle">Meal Rate</p>
          </article>
        </div>

        <div class="tile is-parent">
          <article class="tile is-child box">
            <p class="title">৳<%= totalCost %></p>
            <p class="subtitle">Total Cost</p>
          </article>
        </div>

        <div class="tile is-parent">
          <article class="tile is-child box">
            <p class="title"><%= totalIncome %></p>
            <p class="subtitle">Total Income</p>
          </article>
        </div>

        <div class="tile is-parent">
          <article class="tile is-child box">
            <p class="title"><%= totalIncome - totalCost %></p>
            <p class="subtitle">Balance</p>
          </article>
        </div>
        
      </div><!--end of div class="tile is-ancestor -->   
    </section> <!--End of Section info tiles-->

    <div class="columns is-desktop">
      
      <div class="column is-5">
        <div class="card events-card">

          <header class="card-header">
            <p class="card-header-title">
              এ মাসের প্রণামী যারা এখনো দেয়নি                 
            </p>
            <a href="#" class="card-header-icon" aria-label="more options">
              <span class="icon"><i class="fa fa-angle-down" aria-hidden="true"></i></span>
            </a>
          </header>

          <div class="card-table">
            <div class="content">
              <table class="table is-fullwidth is-striped">
                <tbody class="has-text-centered">
                  <% for(let d in devotee){if(devotee[d].deposits >= 0){%>
                    <tr >
                      <td width="5%"><i class="fa fa-times"></i></td>
                      <td width="15%"><%= parseInt(d)+1 %></td>
                      <td width="55%"><a href="/devotee/<%=devotee[d]._id %>"><%= devotee[d].name %></a></td>
                      <td width="25%" ><button class="button is-small is-primary deposit-modal" data-id="<%= devotee[d]._id %>" data-modal-id="#deposit-modal">জমা</button></td>
                    </tr>
                  <% }} %>
                </tbody>
              </table>
            </div>
          </div> <!--End of card table div-->           
        </div> <!-- end of events card-->

        <div class="card events-card">
          <header class="card-header">
            <a href="#" class="card-header-icon" aria-label="more options">
              <span class="icon"><i class="fa fa-angle-down" aria-hidden="true"></i></span>
            </a>
          </header>

          <div class="card-table">
            <div class="content">
              <table class="table is-fullwidth is-striped is-responsive is-folded" id="depoTab">
                <tbody class="has-text-centered">
                  <% for(let d in devotee){%>
                    <tr >
                      <td width="5%"><i class="fa fa-check"></i></td>
                      <td width="15%"><%= parseInt(d)+1 %></td>
                      <td width="55%"><a href="/devotee/<%=devotee[d]._id %>"><%= devotee[d].name %></a></td>
                      <td width="25%" ><button class="button is-small is-primary deposit-modal" data-id="<%= devotee[d]._id %>" data-modal-id="#deposit-modal">জমা</button></td>
                    </tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div> <!--End of card table div-->

          <footer class="card-footer">
            <span class="card-footer-item view-all button">View All</span>
          </footer>
          
        </div> <!-- end of events card-->   

      </div><!--End of Column -->
          
      <!-- <div class="column is-1"></div> -->
      
      <div class="column is-7">
        <div class="card events-card" id="monthlyChart">
          <header class="card-header">
            <p class="card-header-title">
              <%= month %> এর হিসাব
            </p>
            <div href="#" class="card-header-icon buttons" aria-label="more options">
              <a class="button is-small is-primary excelButton" id="excel"><i class="fa fa-file-excel-o" aria-hidden="true"></i></a>
              <a class="button is-small is-link printButton" ><i class="fa fa-print" aria-hidden="true"></i></a>
              <a class="button is-small is-danger" id="pdf"><i class="fa fa-file-pdf-o" aria-hidden="true"></i></a>
            </div>    
          </header>
          
          <div class="card-content">
            <table class="display nowrap is-responsive" id="example" style="width:100%">
              <thead>
                  <tr>
                    <td>নং</td>
                    <td>নাম</td>
                    <td>মিল</td>
                    <td>জমা</td>
                    <td>খরচ</td>
                    <td>হিসাব</td>
                  </tr>
              </thead>
              <tbody>
                  <% for(let x in result){ %>
                    <% let mark='red'; for(q in devotee[x].costs){ if(devotee[x].costs[q].market === 'কাওরান বাজার' ){ mark='white';}}%>
                    <tr class="<%= mark %>">
                      <td><%= parseInt(x)+1 %></td>
                      <td><a href="/devotee/<%=devotee[x]._id %>"><%= result[x].name %></a></td>
                      <td><span class="tag is-success"><%= result[x].meals %></span></td>
                      <td>৳<%= result[x].deposits %></td>
                      <% let thCost =Math.floor(result[x].meals*mealRate); %>
                      <td><%= thCost %></td>
                      <td><%= thCost - result[x].deposits %></td>
                    </tr>
                  <% } %>
               </tbody>
                      <tfoot>
                        <tr>
                          <td></td>
                          <td>Total</td>
                          <td><span class="tag is-success"><%= sum(totalM) %></span></td>
                          <td >৳<%= sum(totalD) %></td>
                          <td></td>
                          <td  class="has-text-right"></td>
                        </tr>
                      </tfoot>
                    <!-- </tbody>    -->
            </table>     
          </div> <!--Card content -->
                  
        </div> <!--End of card-->       
      </div> <!--End of column is-5 of month table-->          
    </div> <!--End of column-->
  
  </div><!--End of id main-->
</div><!--End of container div-->


<div aria-hidden="" class="modal is-mobile" id="deposit-modal">
    <div class="modal-background close-modal" data-modal-id="#deposit-modal"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Deposit for: <span class="deposit-name"></span></p>
            <button aria-label="close" class="delete close-modal" data-modal-id="#deposit-modal"></button>
        </header>
        <section class="modal-card-body">
            <form method="POST" id="depositForm">          
                <div class="field">
                    <div class="control has-icons-left">
                        <span class="icon is-small is-left">
                            <i class="fa" aria-hidden="true">৳</i>
                        </span>
                        <input class="input" type="text" placeholder="টাকার পরিমাণ" name="depositAmount">
                    </div>
                </div>
                <div class="field">
                    <div class="control has-icons-left">
                        <span class="icon is-small is-left">
                            <i class="fa fa-phone" aria-hidden="true"></i>
                        </span>
                        <input class="input default-date" type="date" name="depositDate">
                    </div>
                </div>
            <!-- </form> -->
                <div class="field is-grouped is-grouped-centered">
                    <div class="control">
                        <button class="button is-success" id="depositSend">
                            <span class="icon is-small">
                                <i class="fa fa-check"></i>
                            </span>
                            <span>Save</span>
                        </button>
                    </div>
                    <div class="control">
                        <button class="button is-danger is-outlined" type="reset">
                            <span>Reset</span>
                            <span class="icon is-small">
                                <i class="fa fa-times"></i>
                            </span>
                        </button>
                    </div>
                </div>
            </form>
        </section>
   <!-- <footer class="modal-card-foot">
        </footer> -->
    </div>
</div>

<footer class="footer">
    <div class="container">
        <div class="content has-text-centered">
            <div class="columns is-mobile is-centered">
                <div class="field">
                    <div class="control">
                        <div class="tags has-addons">
                            <a class="tag is-link" href="#">Developed By:</a>
                            <span class="tag"> <a href="https://github.com/sahapranta" target="_blank">@Pranta Saha<i class="fa fa-github"></i></a> </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</footer>

<div id="snackbar">Some text some message..</div>
<!--  <script
src="https://code.jquery.com/jquery-3.3.1.min.js"
integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
crossorigin="anonymous"></script> -->
<script src="https://code.jquery.com/jquery-3.3.1.js"></script>
<!-- <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script> -->
<script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.10.18/b-1.5.4/b-flash-1.5.4/b-html5-1.5.4/b-print-1.5.4/r-2.2.2/datatables.min.js"></script>

<script>
$.extend( $.fn.dataTable.defaults, {
responsive: true
} );

$(document).ready(function() {
$('#example').DataTable({
  buttons: [
        'pdf'
    ]
});
} );
</script>
<script src="/js/html2canvas.js"></script>

<script async type="text/javascript" src="/js/main.js"></script>

    <!-- modal for report bug -->
    <div aria-hidden="" class="modal is-mobile" id="bug-report">
        <div class="modal-background close-modal"  data-modal-id="#bug-report"></div>
        <div class="modal-card">
          <header class="modal-card-head">
              <p class="modal-card-title">Report any problem!</p>
              <button aria-label="close" class="delete close-modal" data-modal-id="#bug-report"></button>
          </header>
          <section class="modal-card-body">
            <form action="/bug" method="POST">
                <div class="field">
                    <div class="control has-icons-left">
                        <span class="icon is-small is-left">
                            <i class="fa fa-bug" aria-hidden="true"></i>
                        </span>
                        <input class="input is-info" type="text" placeholder="Your Name" name="name">
                    </div>
                </div>
                <div class="field">
                    <div class="control">
                      <textarea class="textarea is-info" type="text" name="desc" placeholder="Please Give the problem details here"></textarea>
                    </div>
                </div>
    
                <div class="field is-grouped is-grouped-centered">
                    <div class="control">
                        <button class="button is-success" type="submit">
                            <span class="icon is-small">
                            <i class="fa fa-check"></i>
                            </span>
                            <span>Send</span>
                        </button>
                    </div>
                    <div class="control">
                        <button class="button is-danger is-outlined" type="reset">
                            <span>Reset</span>
                            <span class="icon is-small">
                            <i class="fa fa-times"></i>
                            </span>
                        </button>
                    </div>
                  </div>
            </form>
          </section>
        </div>
    </div>
</body>
</html>
