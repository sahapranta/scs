<% include partials/header %>
<link rel="stylesheet" href="https://cdn.datatables.net/v/dt/dt-1.10.18/b-1.5.4/b-flash-1.5.4/b-html5-1.5.4/b-print-1.5.4/r-2.2.2/datatables.min.css">
<!-- <link rel="stylesheet" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css"> -->
<!-- <link rel="stylesheet" href="https://cdn.datatables.net/r/dt/jq-2.1.4,jszip-2.5.0,pdfmake-0.1.18,dt-1.10.9,af-2.0.0,b-1.0.3,b-colvis-1.0.3,b-html5-1.0.3,b-print-1.0.3,se-1.0.1/datatables.min.css"/> -->
<!-- <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.2.3/css/responsive.dataTables.min.css"> -->
<div class="container load">
  <div class="column is-12" id="main">
    
    <section class="hero is-info welcome is-small">
      <div class="hero-body">
        <div class="container">
          <h1 class="title"><span style="cursor:pointer" onclick="openNav()">&#9776;</span> Hello, Admin. </h1>
        </div>
      </div>
    </section>
    <% let result = devotee.map(({name, meals, deposits}) => ({name, meals : meals.reduce((a,c) => a + c.num, 0), deposits : deposits.reduce((a,c) => a + c.amount, 0)})); %>
    <% var totalD= [], totalM = []; for(let f in result){totalD.push(result[f].deposits); totalM.push(result[f].meals);} %>
    <% var tCosts= []; for(let i in cost){tCosts.push(cost[i].amount);} function sum(num){return num.reduce((a,b)=>{return a+b;}, 0);} %>
    
    <section class="info-tiles">
      <div class="tile is-ancestor has-text-centered">
        
        <div class="tile is-parent">
          <article class="tile is-child box">
<% var mealRate = Math.round(sum(tCosts)/sum(totalM)).toFixed(2); var totalCost =sum(tCosts); var totalIncome =sum(totalD);  %>
            <p class="title"><%= mealRate  %></p>
            <p class="subtitle">Meal Rate</p>
          </article>
        </div>

        <div class="tile is-parent">
          <article class="tile is-child box">
            <p class="title">৳<%= totalCost %></p>
            <p class="subtitle">Total Cost</p>
          </article>
        </div>

        <div class="tile is-parent">
          <article class="tile is-child box">
            <p class="title"><%= totalIncome %></p>
            <p class="subtitle">Total Income</p>
          </article>
        </div>

        <div class="tile is-parent">
          <article class="tile is-child box">
            <p class="title"><%= totalIncome - totalCost %></p>
            <p class="subtitle">Balance</p>
          </article>
        </div>
        
      </div><!--end of div class="tile is-ancestor -->   
    </section> <!--End of Section info tiles-->

    <div class="columns is-desktop">
      
      <div class="column is-5">
        <div class="card events-card">

          <header class="card-header">
            <p class="card-header-title">
              এ মাসের প্রণামী যারা এখনো দেয়নি                 
            </p>
            <a href="#" class="card-header-icon" aria-label="more options">
              <span class="icon"><i class="fa fa-angle-down" aria-hidden="true"></i></span>
            </a>
          </header>

          <div class="card-table">
            <div class="content">
              <table class="table is-fullwidth is-striped">
                <tbody class="has-text-centered">
                  <% for(let d in devotee){if(devotee[d].deposits >= 0){%>
                    <tr >
                      <td width="5%"><i class="fa fa-times"></i></td>
                      <td width="15%"><%= parseInt(d)+1 %></td>
                      <td width="55%"><a href="/devotee/<%=devotee[d]._id %>"><%= devotee[d].name %></a></td>
                      <td width="25%" ><button class="button is-small is-primary deposit-modal" data-id="<%= devotee[d]._id %>" data-modal-id="#deposit-modal">জমা</button></td>
                    </tr>
                  <% }} %>
                </tbody>
              </table>
            </div>
          </div> <!--End of card table div-->           
        </div> <!-- end of events card-->

        <div class="card events-card">
          <header class="card-header">
            <a href="#" class="card-header-icon" aria-label="more options">
              <span class="icon"><i class="fa fa-angle-down" aria-hidden="true"></i></span>
            </a>
          </header>

          <div class="card-table">
            <div class="content">
              <table class="table is-fullwidth is-striped is-responsive is-folded" id="depoTab">
                <tbody class="has-text-centered">
                  <% for(let d in devotee){%>
                    <tr >
                      <td width="5%"><i class="fa fa-check"></i></td>
                      <td width="15%"><%= parseInt(d)+1 %></td>
                      <td width="55%"><a href="/devotee/<%=devotee[d]._id %>"><%= devotee[d].name %></a></td>
                      <td width="25%" ><button class="button is-small is-primary deposit-modal" data-id="<%= devotee[d]._id %>" data-modal-id="#deposit-modal">জমা</button></td>
                    </tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div> <!--End of card table div-->

          <footer class="card-footer">
            <span class="card-footer-item view-all button">View All</span>
          </footer>
          
        </div> <!-- end of events card-->   

      </div><!--End of Column -->
          
      <!-- <div class="column is-1"></div> -->
      
      <div class="column is-7">
        <div class="card events-card" id="monthlyChart">
          <header class="card-header">
            <p class="card-header-title">
              <%= month %> এর হিসাব
            </p>
            <div href="#" class="card-header-icon buttons" aria-label="more options">
              <a class="button is-small is-primary excelButton" id="excel"><i class="fa fa-file-excel-o" aria-hidden="true"></i></a>
              <a class="button is-small is-link printButton" ><i class="fa fa-print" aria-hidden="true"></i></a>
              <a class="button is-small is-danger" id="pdf"><i class="fa fa-file-pdf-o" aria-hidden="true"></i></a>
            </div>    
          </header>
          
          <div class="card-content">
            <table class="display nowrap is-responsive" id="example" style="width:100%">
              <thead>
                  <tr>
                    <td>নং</td>
                    <td>নাম</td>
                    <td>মিল</td>
                    <td>জমা</td>
                    <td>খরচ</td>
                    <td>হিসাব</td>
                  </tr>
              </thead>
              <tbody>
                  <% for(let x in result){ %>
                    <% let mark='red'; for(q in devotee[x].costs){ if(devotee[x].costs[q].market === 'কাওরান বাজার' ){ mark='white';}}%>
                    <tr class="<%= mark %>">
                      <td><%= parseInt(x)+1 %></td>
                      <td><a href="/devotee/<%=devotee[x]._id %>"><%= result[x].name %></a></td>
                      <td><span class="tag is-success"><%= result[x].meals %></span></td>
                      <td>৳<%= result[x].deposits %></td>
                      <% let thCost =Math.floor(result[x].meals*mealRate); %>
                      <td><%= thCost %></td>
                      <td><%= thCost - result[x].deposits %></td>
                    </tr>
                  <% } %>
               </tbody>
                      <tfoot>
                        <tr>
                          <td></td>
                          <td>Total</td>
                          <td><span class="tag is-success"><%= sum(totalM) %></span></td>
                          <td >৳<%= sum(totalD) %></td>
                          <td></td>
                          <td  class="has-text-right"></td>
                        </tr>
                      </tfoot>
                    <!-- </tbody>    -->
            </table>     
          </div> <!--Card content -->
                  
        </div> <!--End of card-->       
      </div> <!--End of column is-5 of month table-->          
    </div> <!--End of column-->
  
  </div><!--End of id main-->
</div><!--End of container div-->


<div aria-hidden="" class="modal is-mobile" id="deposit-modal">
    <div class="modal-background close-modal" data-modal-id="#deposit-modal"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Deposit for: <span class="deposit-name"></span></p>
            <button aria-label="close" class="delete close-modal" data-modal-id="#deposit-modal"></button>
        </header>
        <section class="modal-card-body">
            <form method="POST" id="depositForm">          
                <div class="field">
                    <div class="control has-icons-left">
                        <span class="icon is-small is-left">
                            <i class="fa" aria-hidden="true">৳</i>
                        </span>
                        <input class="input" type="text" placeholder="টাকার পরিমাণ" name="depositAmount">
                    </div>
                </div>
                <div class="field">
                    <div class="control has-icons-left">
                        <span class="icon is-small is-left">
                            <i class="fa fa-phone" aria-hidden="true"></i>
                        </span>
                        <input class="input default-date" type="date" name="depositDate">
                    </div>
                </div>
            <!-- </form> -->
                <div class="field is-grouped is-grouped-centered">
                    <div class="control">
                        <button class="button is-success" id="depositSend">
                            <span class="icon is-small">
                                <i class="fa fa-check"></i>
                            </span>
                            <span>Save</span>
                        </button>
                    </div>
                    <div class="control">
                        <button class="button is-danger is-outlined" type="reset">
                            <span>Reset</span>
                            <span class="icon is-small">
                                <i class="fa fa-times"></i>
                            </span>
                        </button>
                    </div>
                </div>
            </form>
        </section>
   <!-- <footer class="modal-card-foot">
        </footer> -->
    </div>
</div>

<footer class="footer">
    <div class="container">
        <div class="content has-text-centered">
            <div class="columns is-mobile is-centered">
                <div class="field">
                    <div class="control">
                        <div class="tags has-addons">
                            <a class="tag is-link" href="#">Developed By:</a>
                            <span class="tag"> <a href="https://github.com/sahapranta" target="_blank">@Pranta Saha<i class="fa fa-github"></i></a> </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</footer>

<div id="snackbar">Some text some message..</div>
<!--  <script
src="https://code.jquery.com/jquery-3.3.1.min.js"
integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
crossorigin="anonymous"></script> -->
<script src="https://code.jquery.com/jquery-3.3.1.js"></script>
<!-- <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script> -->
<script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.10.18/b-1.5.4/b-flash-1.5.4/b-html5-1.5.4/b-print-1.5.4/r-2.2.2/datatables.min.js"></script>

<script>
$.extend( $.fn.dataTable.defaults, {
responsive: true
} );

$(document).ready(function() {
$('#example').DataTable({
  buttons: [
        'pdf'
    ]
});
} );
</script>
<script src="/js/html2canvas.js"></script>

<script async type="text/javascript" src="/js/main.js"></script>

    <!-- modal for report bug -->
    <div aria-hidden="" class="modal is-mobile" id="bug-report">
        <div class="modal-background close-modal"  data-modal-id="#bug-report"></div>
        <div class="modal-card">
          <header class="modal-card-head">
              <p class="modal-card-title">Report any problem!</p>
              <button aria-label="close" class="delete close-modal" data-modal-id="#bug-report"></button>
          </header>
          <section class="modal-card-body">
            <form action="/bug" method="POST">
                <div class="field">
                    <div class="control has-icons-left">
                        <span class="icon is-small is-left">
                            <i class="fa fa-bug" aria-hidden="true"></i>
                        </span>
                        <input class="input is-info" type="text" placeholder="Your Name" name="name">
                    </div>
                </div>
                <div class="field">
                    <div class="control">
                      <textarea class="textarea is-info" type="text" name="desc" placeholder="Please Give the problem details here"></textarea>
                    </div>
                </div>
    
                <div class="field is-grouped is-grouped-centered">
                    <div class="control">
                        <button class="button is-success" type="submit">
                            <span class="icon is-small">
                            <i class="fa fa-check"></i>
                            </span>
                            <span>Send</span>
                        </button>
                    </div>
                    <div class="control">
                        <button class="button is-danger is-outlined" type="reset">
                            <span>Reset</span>
                            <span class="icon is-small">
                            <i class="fa fa-times"></i>
                            </span>
                        </button>
                    </div>
                  </div>
            </form>
          </section>
        </div>
    </div>
</body>
</html>